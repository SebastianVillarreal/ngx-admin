<nb-card>
  <nb-card-header class="card-header">
    <div>
      <h2 class="title">Créditos | Detalle Cliente</h2>
      <p class="subtitle">Consulta y administra la información del crédito seleccionado.</p>
    </div>
    <div class="header-actions">
      <button nbButton status="success" size="small" (click)="crearFolio()" [disabled]="folioLoading">
        <nb-icon icon="plus-outline" *ngIf="!folioLoading"></nb-icon>
        <nb-spinner *ngIf="folioLoading" size="tiny"></nb-spinner>
        {{ folioLoading ? 'Creando…' : 'Crear Folio' }}
      </button>
      <button nbButton status="warning" size="small" (click)="finalizarCredito()">
        Finalizar
      </button>
      <button nbButton status="danger" size="small" (click)="cancelarOperacion()">
        Cancelar
      </button>
      <button nbButton status="info" size="small" appearance="outline" (click)="verHistorico()">
        Histórico
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <div class="state" *ngIf="loadingDetalle">
      <nb-spinner status="primary"></nb-spinner>
      <span>Cargando detalle del cliente…</span>
    </div>

    <nb-alert status="danger" *ngIf="!loadingDetalle && detalleError">
      {{ detalleError }}
    </nb-alert>

    <form *ngIf="!loadingDetalle && !detalleError" [formGroup]="detalleForm" class="form-grid">
      <div class="form-field">
        <label>*Nombre:</label>
        <input nbInput fullWidth formControlName="nombre" readonly />
      </div>
      <div class="form-field">
        <label>*Límite Crédito:</label>
        <input nbInput fullWidth formControlName="limiteCredito" readonly />
      </div>
      <div class="form-field">
        <label>*Deuda Actual:</label>
        <input nbInput fullWidth formControlName="deudaActual" readonly />
      </div>
      <div class="form-field">
        <label>*Crédito Disponible:</label>
        <input nbInput fullWidth formControlName="creditoDisponible" readonly />
      </div>
      <div class="form-field">
        <label>*Forma Pago:</label>
        <nb-select fullWidth placeholder="Seleccione" formControlName="formaPago">
          <nb-option *ngFor="let option of formaPagoOptions" [value]="option.value">
            {{ option.label }}
          </nb-option>
        </nb-select>
      </div>
      <div class="form-field">
        <label>*Referencia:</label>
        <input nbInput fullWidth formControlName="referencia" placeholder="Referencia" />
      </div>
      <div class="form-field">
        <label>*Folio Op:</label>
        <input nbInput fullWidth formControlName="folioOp" placeholder="0" />
      </div>
    </form>
    <nb-alert status="success" *ngIf="folioSuccess">
      {{ folioSuccess }}
    </nb-alert>
    <nb-alert status="danger" *ngIf="folioError">
      {{ folioError }}
    </nb-alert>
  </nb-card-body>
</nb-card>

<nb-card>
  <nb-card-header class="card-header secondary">
    <div>
      <h2 class="title">Créditos | Detalle Cliente</h2>
      <p class="subtitle">Detalle de folios activos.</p>
    </div>
    <button nbButton status="success" size="small" (click)="exportFolios()" [disabled]="!folios.length">
      <nb-icon icon="download-outline"></nb-icon>
      Exportar Excel
    </button>
  </nb-card-header>
  <nb-card-body>
    <ng-container *ngIf="folios.length; else noFolios">
      <table class="detalle-table">
        <thead>
          <tr>
            <th>Folio Interno</th>
            <th>Total</th>
            <th>Abonado</th>
            <th>Restante</th>
            <th>Fecha</th>
            <th>Fecha Vencimiento</th>
            <th>Registrar abono</th>
            <th>Acciones</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let folio of folios">
            <td>{{ folio.folioInterno }}</td>
            <td>{{ folio.total | currency: 'MXN':'symbol-narrow' }}</td>
            <td>{{ folio.abonado | currency: 'MXN':'symbol-narrow' }}</td>
            <td>{{ folio.restante | currency: 'MXN':'symbol-narrow' }}</td>
            <td>{{ folio.fecha | date: 'dd/MM/yyyy' }}</td>
            <td>{{ folio.fechaVencimiento | date: 'dd/MM/yyyy' }}</td>
            <td class="abono-input">
              <input
                nbInput
                type="number"
                size="small"
                placeholder="Monto"
                min="0"
                [max]="folio.restante"
                [disabled]="abonoLoadingMap[folio.folioInterno]"
                [(ngModel)]="abonoInputs[folio.folioInterno]"
                [ngModelOptions]="{ standalone: true }"
                (keyup.enter)="submitAbono(folio)"
              />
              <div class="abono-feedback">
                <small class="error-text" *ngIf="abonoErrorMap[folio.folioInterno]">
                  {{ abonoErrorMap[folio.folioInterno] }}
                </small>
                <small class="success-text" *ngIf="abonoSuccessMap[folio.folioInterno]">
                  {{ abonoSuccessMap[folio.folioInterno] }}
                </small>
              </div>
            </td>
            <td class="acciones">
              <button nbButton size="tiny" status="danger">Detalle</button>
              <button nbButton size="tiny" status="success" (click)="openAbonosDialog(folio)">
                Lista Abonos
              </button>
              <button nbButton size="tiny" status="info">Abonar</button>
            </td>
            <td class="checkbox">
              <nb-checkbox
                [checked]="abonoAutoCheck[folio.folioInterno] || false"
                (checkedChange)="handleAutoAbonoToggle(folio, $event)"
                [disabled]="abonoLoadingMap[folio.folioInterno] || (folio.restante ?? 0) <= 0"
              ></nb-checkbox>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="resumen">Total Restante:</td>
            <td>{{ totalRestante | currency: 'MXN':'symbol-narrow' }}</td>
            <td colspan="2" class="resumen">Total Restante x Página:</td>
            <td colspan="2">{{ totalRestantePagina | currency: 'MXN':'symbol-narrow' }}</td>
          </tr>
        </tfoot>
      </table>
    </ng-container>
    <ng-template #noFolios>
      <div class="empty-state">
        <nb-icon icon="inbox-outline"></nb-icon>
        <p>No hay folios registrados para este cliente.</p>
      </div>
    </ng-template>
  </nb-card-body>
</nb-card>

<ng-template #abonosDialog let-ref="dialogRef">
  <nb-card class="abonos-dialog">
    <nb-card-header class="card-header">
      <div>
        <h2 class="title">Lista de abonos</h2>
        <p class="subtitle">Folio: {{ abonosFolio }}</p>
      </div>
      <button nbButton ghost status="basic" size="small" (click)="closeAbonosDialog()">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </nb-card-header>
    <nb-card-body>
      <div class="state" *ngIf="abonosLoading">
        <nb-spinner status="primary"></nb-spinner>
        <span>Cargando abonos…</span>
      </div>
      <nb-alert status="danger" *ngIf="!abonosLoading && abonosError">
        {{ abonosError }}
      </nb-alert>
      <div *ngIf="!abonosLoading && !abonosError">
        <ng-container *ngIf="abonosTicket.length; else sinAbonosDialog">
          <table class="detalle-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Monto</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let abono of abonosTicket">
                <td>{{ abono.Id }}</td>
                <td>{{ abono.Monto | currency: 'MXN':'symbol-narrow' }}</td>
                <td>{{ abono.Fecha }}</td>
              </tr>
            </tbody>
          </table>
        </ng-container>
        <ng-template #sinAbonosDialog>
          <div class="empty-state">
            <nb-icon icon="inbox-outline"></nb-icon>
            <p>No hay abonos registrados para este folio.</p>
          </div>
        </ng-template>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #finalizarDialog let-ref="dialogRef">
  <nb-card class="finalizar-dialog">
    <nb-card-header class="card-header">
      <div>
        <h2 class="title">Resumen Ticket</h2>
        <p class="subtitle">Confirma los datos para cerrar el abono.</p>
      </div>
      <button nbButton ghost status="basic" size="small" (click)="closeFinalizarDialog()">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </nb-card-header>
    <nb-card-body>
      <nb-alert status="danger" *ngIf="finalizarDialogError">
        {{ finalizarDialogError }}
      </nb-alert>
      <div class="finalizar-grid">
        <div class="form-field">
          <label>*Total abonado:</label>
          <input nbInput fullWidth [value]="totalFinalizarAbono | currency: 'MXN':'symbol-narrow'" readonly />
        </div>
        <div class="form-field">
          <label>*Monto:</label>
          <div class="currency-input">
            <span>$</span>
            <input
              nbInput
              fullWidth
              type="number"
              min="0"
              [disabled]="finalizarLoading"
              [value]="montoFinalizar"
              (input)="onMontoFinalizarChange($event.target.value)"
              placeholder="Monto recibido"
            />
          </div>
        </div>
        <div class="form-field">
          <label>*Cambio:</label>
          <div class="currency-input">
            <span>$</span>
            <input
              nbInput
              fullWidth
              readonly
              [value]="cambioFinalizar | number: '1.2-2'"
            />
          </div>
        </div>
      </div>
    </nb-card-body>
    <nb-card-footer class="dialog-footer">
      <button nbButton status="danger" (click)="closeFinalizarDialog()" [disabled]="finalizarLoading">
        Cancelar
      </button>
      <button
        nbButton
        status="success"
        (click)="confirmarFinalizarAbono()"
        [disabled]="!finalizarPuedeCerrar || finalizarLoading"
      >
        <nb-spinner size="tiny" *ngIf="finalizarLoading"></nb-spinner>
        <span *ngIf="!finalizarLoading">Finalizar</span>
      </button>
    </nb-card-footer>
  </nb-card>
</ng-template>

<nb-card>
  <nb-card-header class="card-header secondary">
    <div>
      <h2 class="title">Créditos | Detalle Abono</h2>
      <p class="subtitle">Historial de abonos registrados.</p>
    </div>
    <div class="header-actions">
      <label>Mostrar</label>
      <nb-select size="small" [selected]="abonosPorPagina" (selectedChange)="abonosPorPagina = $event">
        <nb-option *ngFor="let size of abonosPageOptions" [value]="size">{{ size }}</nb-option>
      </nb-select>
      <span>registros</span>
    </div>
  </nb-card-header>
  <nb-card-body>
    <div class="state" *ngIf="detalleAbonosLoading">
      <nb-spinner status="primary"></nb-spinner>
      <span>Cargando detalle de abonos…</span>
    </div>
    <nb-alert status="danger" *ngIf="!detalleAbonosLoading && detalleAbonosError">
      {{ detalleAbonosError }}
    </nb-alert>
    <ng-container *ngIf="!detalleAbonosLoading && !detalleAbonosError">
      <ng-container *ngIf="detalleAbonos.length; else sinDetalleAbonos">
        <table class="detalle-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Folio Interno</th>
              <th>Monto</th>
              <th>Restante</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let abono of detalleAbonos | slice: 0 : abonosPorPagina">
              <td>{{ abono.Id }}</td>
              <td>{{ abono.FolioInterno }}</td>
              <td>{{ abono.Abono | currency: 'MXN':'symbol-narrow' }}</td>
              <td>{{ abono.Restante | currency: 'MXN':'symbol-narrow' }}</td>
              <td>{{ abono.Fecha || '---' }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2" class="resumen">Total monto:</td>
              <td>{{ totalDetalleAbonos | currency: 'MXN':'symbol-narrow' }}</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </ng-container>
      <ng-template #sinDetalleAbonos>
        <div class="empty-state">
          <nb-icon icon="inbox-outline"></nb-icon>
          <p>Ningún dato disponible en esta tabla =(</p>
        </div>
      </ng-template>
    </ng-container>
  </nb-card-body>
</nb-card>
