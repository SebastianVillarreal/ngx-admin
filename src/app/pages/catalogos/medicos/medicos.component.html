<nb-card>
  <nb-card-header class="card-header">
    <div>
      <h2 class="title">Médicos</h2>
      <p class="subtitle">Directorio de médicos con sus datos de contacto y estatus.</p>
    </div>
    <div class="header-actions">
      <button
        nbButton
        status="success"
        size="small"
        (click)="exportToExcel()"
        [disabled]="loading || !filteredMedicos.length"
      >
        <nb-icon icon="download-outline"></nb-icon>
        Exportar Excel
      </button>
      <button nbButton status="primary" size="small" (click)="loadMedicos()" [disabled]="loading">
        <nb-icon icon="refresh-outline"></nb-icon>
        Actualizar
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <section class="create-section">
      <div>
        <h3 class="section-title">Registrar nuevo médico</h3>
        <p class="section-subtitle">Completa la información para agregar médicos al catálogo.</p>
      </div>

      <nb-alert status="success" *ngIf="createSuccess">
        {{ createSuccess }}
      </nb-alert>

      <nb-alert status="danger" *ngIf="createError">
        {{ createError }}
      </nb-alert>

      <form [formGroup]="createForm" (ngSubmit)="submitNewMedico()" class="create-form">
        <div class="form-grid">
          <div class="form-field">
            <label>Número *</label>
            <input nbInput fullWidth formControlName="Numero" placeholder="Ej. 101" />
            <span class="field-error" *ngIf="hasFieldError('Numero')">El número es obligatorio.</span>
          </div>
          <div class="form-field">
            <label>Cédula *</label>
            <input nbInput fullWidth formControlName="Cedula" placeholder="Ej. 1153182" />
            <span class="field-error" *ngIf="hasFieldError('Cedula')">La cédula es obligatoria.</span>
          </div>
          <div class="form-field">
            <label>Nombre *</label>
            <input nbInput fullWidth formControlName="Nombre" placeholder="Nombre(s)" />
            <span class="field-error" *ngIf="hasFieldError('Nombre')">El nombre es obligatorio.</span>
          </div>
          <div class="form-field">
            <label>Apellido paterno *</label>
            <input nbInput fullWidth formControlName="ApPaterno" placeholder="Apellido paterno" />
            <span class="field-error" *ngIf="hasFieldError('ApPaterno')">El apellido paterno es obligatorio.</span>
          </div>
          <div class="form-field">
            <label>Apellido materno</label>
            <input nbInput fullWidth formControlName="ApMaterno" placeholder="Apellido materno" />
          </div>
          <div class="form-field domicilio">
            <label>Domicilio *</label>
            <textarea nbInput rows="2" formControlName="Domicilio" placeholder="Dirección completa"></textarea>
            <span class="field-error" *ngIf="hasFieldError('Domicilio')">El domicilio es obligatorio.</span>
          </div>
          <div class="form-field">
            <label>Teléfono móvil</label>
            <input nbInput fullWidth formControlName="Telefono" placeholder="10 dígitos" />
          </div>
          <div class="form-field">
            <label>Teléfono casa</label>
            <input nbInput fullWidth formControlName="TelefonoCasa" placeholder="10 dígitos" />
          </div>
        </div>

        <div class="form-actions">
          <button nbButton status="primary" type="submit" [disabled]="isSubmitDisabled">
            {{ creating ? 'Guardando…' : 'Registrar médico' }}
          </button>
          <button nbButton status="basic" type="button" (click)="resetCreateForm()" [disabled]="creating">
            Limpiar
          </button>
        </div>
      </form>
    </section>

    <div class="state" *ngIf="loading">
      <nb-spinner status="primary"></nb-spinner>
      <span>Cargando información, por favor espera…</span>
    </div>

    <nb-alert status="danger" *ngIf="!loading && errorMessage">
      <div class="alert-content">
        <span>{{ errorMessage }}</span>
        <button nbButton status="danger" size="tiny" outline (click)="loadMedicos()">
          Reintentar
        </button>
      </div>
    </nb-alert>

    <div class="table-container" *ngIf="!loading && !errorMessage">
      <div class="controls">
        <div class="search-control">
          <nb-icon icon="search-outline"></nb-icon>
          <input
            nbInput
            fullWidth
            type="text"
            placeholder="Buscar por número, cédula, nombre o domicilio"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearch($event)"
          />
        </div>
        <div class="page-size-control">
          <label>Registros por página</label>
          <nb-select size="small" [selected]="pageSize" (selectedChange)="changePageSize($event)">
            <nb-option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</nb-option>
          </nb-select>
        </div>
      </div>

      <ng-container *ngIf="paginatedMedicos.length; else emptyState">
        <table class="medicos-table">
          <thead>
            <tr>
              <th>Número</th>
              <th>Nombre</th>
              <th>Cédula</th>
              <th>Teléfono</th>
              <th>Domicilio</th>
              <th>Estatus</th>
              <th class="acciones">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let medico of paginatedMedicos; trackBy: trackById">
              <td>{{ medico.Numero }}</td>
              <td>{{ getNombreCompleto(medico) }}</td>
              <td>{{ medico.Cedula }}</td>
              <td>{{ getTelefonoPreferido(medico) }}</td>
              <td>{{ medico.Domicilio }}</td>
              <td>
                <nb-badge
                  [text]="getEstatusLabel(medico.Estatus)"
                  [status]="getEstatusStatus(medico.Estatus)"
                ></nb-badge>
              </td>
              <td class="acciones">
                <button nbButton size="tiny" status="basic" hero (click)="onView(medico)">
                  <nb-icon icon="eye-outline"></nb-icon>
                </button>
                <button nbButton size="tiny" status="warning" hero (click)="onEdit(medico)">
                  <nb-icon icon="edit-2-outline"></nb-icon>
                </button>
                <button nbButton size="tiny" status="danger" hero (click)="onDelete(medico)">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </ng-container>

      <ng-template #emptyState>
        <div class="empty-state">
          <nb-icon icon="inbox-outline"></nb-icon>
          <p>No encontramos resultados que coincidan con tu búsqueda.</p>
        </div>
      </ng-template>

      <div class="pagination-bar" *ngIf="totalItems">
        <span>Mostrando {{ rangeStart }} - {{ rangeEnd }} de {{ totalItems }} registros</span>
        <div class="pagination-controls">
          <button nbButton size="tiny" status="basic" (click)="goToPreviousPage()" [disabled]="page === 1">
            <nb-icon icon="arrow-back-outline"></nb-icon>
          </button>
          <span>Página {{ page }} de {{ totalPages }}</span>
          <button
            nbButton
            size="tiny"
            status="basic"
            (click)="goToNextPage()"
            [disabled]="page === totalPages"
          >
            <nb-icon icon="arrow-forward-outline"></nb-icon>
          </button>
        </div>
      </div>
    </div>
  </nb-card-body>
</nb-card>
